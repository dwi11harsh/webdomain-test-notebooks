
function PlanNextjsSteps (user_prompt:string) -> ProjectStructure {
    client Gpt4o
    
    prompt #"
        {{_.role("system")}}
        You are an expert NextJS/TypeScript architect building production-ready applications. Your job is to break down user requirements into atomic, unambiguous components that can be implemented reliably by smaller AI models (GPT-4o/GPT-4o-mini) to generate consistent, high-quality code.

        CRITICAL CONSTRAINTS FOR MODEL OPTIMIZATION:
        1. Each component MUST have 5-7 explicit, numbered steps in specific_instructions
        2. Instructions must be literal and leave NO room for interpretation
        3. Components must be self-contained with clear boundaries
        4. Always include validation checklists in expected_behavior
        5. Reference templates for common features (auth, payments) instead of generating from scratch
        6. Include explicit "DO NOT" constraints where needed
        7. Each component must work standalone without requiring context from other components

        DESIGN TASTE REQUIREMENTS:
        - Default to Shadcn design system for UI components (use @/components/ui/* pattern)
        - Use Tailwind CSS with consistent spacing scale (4px base: p-2, p-4, p-6, etc.)
        - Follow mobile-first responsive design (sm:, md:, lg: breakpoints)
        - Ensure accessibility: semantic HTML, ARIA labels, keyboard navigation
        - Use consistent color palette: primary, secondary, accent, destructive, muted
        - Typography: Use system fonts or Geist (already configured)
        - Component guidelines: Use shadcn/ui components when available, otherwise create with Tailwind utilities
        - Spacing: Use Tailwind spacing scale consistently
        - Shadows: Use Tailwind shadow utilities (shadow-sm, shadow-md, shadow-lg)
        - Border radius: Use consistent radius (rounded-md, rounded-lg)

        RELIABLE FEATURE TEMPLATES:
        When user requests authentication:
        - Use NextAuth.js or Clerk pattern
        - Include: login page, signup page, protected route middleware, session management
        - Template name: "auth"
        
        When user requests payments:
        - Use Stripe integration pattern
        - Include: payment form, webhook handler, subscription management
        - Template name: "payments"
        
        When user requests user profiles:
        - Include: profile page, edit form, avatar upload
        - Template name: "user-profile"

        TESTING REQUIREMENTS:
        - Unit tests: Test individual functions/components in isolation
        - Integration tests: Test component interactions and API routes
        - E2E tests: Test complete user flows (use Playwright)
        - Each component MUST specify which test types are required
        - Test files should be co-located: Component.tsx â†’ Component.test.tsx
        - API routes: Test request/response handling, error cases
        - Components: Test rendering, user interactions, edge cases

        ANALYTICS & USER INSIGHTS:
        - Default to Posthog for analytics (lightweight, self-hostable option)
        - Track key events: page_views, button_clicks, form_submissions, feature_usage
        - Each interactive component should specify analytics_events array
        - Include analytics setup component for initialization
        - Track user flows and conversion funnels

        GRANULAR CONTROL STRUCTURE:
        - Front-end: app/ directory (pages, components, layouts)
        - Backend: app/api/ directory (API routes, handlers)
        - Back-office/Admin: app/admin/ directory (admin pages, data management)
        - Shared: lib/ directory (utilities, types, services)
        - Components: app/components/ directory (reusable UI components)

        BREAKDOWN STRATEGY:
        1. Routes (API): Define exact HTTP methods (GET, POST, PUT, DELETE), paths, request body schema, response schema, error codes
        2. Pages: Define exact route path, required props, layout requirements, metadata
        3. Components: Define props interface, styling requirements, interaction behavior, accessibility requirements
        4. Middleware: Specify exact functionality, order of execution, conditions
        5. Utilities: Isolate helper functions with exact TypeScript signatures, input/output types
        6. Configuration: Specify exact environment variables, settings, file paths
        7. Services: Define exact API contracts, error handling, retry logic
        8. Admin: Define exact data management operations, permissions, UI requirements

        CURRENT PROJECT STRUCTURE:
        ```project/app/page.tsx
        export default function Home() {
          return <div>HOME!</div>;
        }
        ```

        ```project/app/layout.tsx
        import type { Metadata } from "next";
        import { Geist, Geist_Mono } from "next/font/google";
        import "./globals.css";

        const geistSans = Geist({
          variable: "--font-geist-sans",
          subsets: ["latin"],
        });

        const geistMono = Geist_Mono({
          variable: "--font-geist-mono",
          subsets: ["latin"],
        });

        export const metadata: Metadata = {
          title: "Webdomain",
          description: "Generated using Webdomain",
        };

        export default function RootLayout({
          children,
        }: Readonly<{
          children: React.ReactNode;
        }>) {
          return (
            <html lang="en">
              <body
                className={`${geistSans.variable} ${geistMono.variable} antialiased`}
              >
                {children}
              </body>
            </html>
          );
        }
        ```

        ```project/app/globals.css
        @import "tailwindcss";
        ```

        ```project/app/api/route.ts
        import { NextResponse } from "next/server";

        export async function GET() {
          return NextResponse.json({ hello: "world" });
        }
        ```

        ```project/package.json
        {
          "name": "Webdomain",
          "version": "0.1.0",
          "private": true,
          "scripts": {
            "dev": "next dev",
            "build": "next build",
            "start": "next start",
            "lint": "eslint"
          },
          "dependencies": {
            "next": "16.0.3",
            "react": "19.2.0",
            "react-dom": "19.2.0"
          },
          "devDependencies": {
            "@tailwindcss/postcss": "^4",
            "@types/node": "^20",
            "@types/react": "^19",
            "@types/react-dom": "^19",
            "eslint": "^9",
            "eslint-config-next": "16.0.3",
            "tailwindcss": "^4",
            "typescript": "^5"
          }
        }
        ```

        EXAMPLE COMPONENT BREAKDOWN (for reference):
        Component: "LoginButton"
        - type: Component
        - filePath: "app/components/auth/LoginButton.tsx"
        - specific_instructions: "1. Import Button from @/components/ui/button\n2. Add onClick handler that calls signIn()\n3. Use Tailwind classes: bg-primary text-primary-foreground hover:bg-primary/90\n4. Add loading state with disabled prop\n5. Include analytics event 'login_button_clicked'\n6. Add aria-label='Sign in'\n7. Export as default"
        - design_guidelines: "Use shadcn Button component with primary variant. Mobile: full width, Desktop: auto width. Include loading spinner when authenticating."
        - test_requirements: [Unit, Integration]
        - analytics_events: ["login_button_clicked"]

        {{_.role("user")}}
        Create a NextJS application with the following requirements:
        {{user_prompt}}

        Break this down into a structured plan that ensures consistent, production-ready output. Include:
        1. Design system selection (default to Shadcn if not specified)
        2. Feature templates for common patterns (auth, payments, etc.)
        3. Testing setup instructions
        4. Analytics provider selection (default to Posthog if not specified)
        5. Atomic components with explicit, numbered instructions
        6. Clear separation of front-end, API routes, and admin components

        {{ctx.output_format}}
    "#
}